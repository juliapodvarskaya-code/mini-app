<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Основной шрифт для всего приложения */
        @font-face {
            font-family: 'AmsterdamFour';
            src: url('amsterdam-four_ttf.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }
        
        body { 
            margin: 0; padding: 0; background: #b0b8d0; 
            font-family: 'AmsterdamFour', cursive; 
            display: flex; flex-direction: column; height: 100vh;
        }

        .container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; flex-shrink: 0; }
        .bg-image { width: 100%; height: auto; display: block; }
        
        /* Цифры на треугольнике */
        .number { 
            position: absolute; transform: translate(-50%, -50%); 
            font-size: 2.8vw; color: #1a1a1a; pointer-events: none; line-height: 1;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        @media (min-width: 500px) { .number { font-size: 14px; } }

        /* Контейнер с текстом */
        .content { 
            flex-grow: 1; background: #ffffff; padding: 25px; 
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 25px rgba(0,0,0,0.1);
            overflow-y: auto; margin-top: -15px; z-index: 10;
            font-family: 'Georgia', 'Times New Roman', Times, serif; /* Классический шрифт для чтения */
            line-height: 1.6;
            color: #000000; /* Весь текст по умолчанию черный */
        }

        /* Вкладки */
        .tabs { display: flex; background: #fff; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .tab { 
            flex: 1; padding: 18px 5px; text-align: center; font-size: 12px; 
            color: #aaa; cursor: pointer; text-transform: uppercase; 
            /* Классический красивый шрифт для вкладок */
            font-family: 'Georgia', 'Times New Roman', serif; 
            letter-spacing: 1px;
        }
        .tab.active { color: #248bcf; font-weight: bold; border-top: 2px solid #248bcf; }

        /* Стили для трактовок */
        .interp-block { margin-bottom: 25px; }
        
        /* Заголовок (Позиция и Аркан) - СИНИЙ */
        .interp-header {
            color: #248bcf;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        /* Описание - ЧЕРНОЕ */
        .interp-body {
            color: #000000;
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* Жирный текст внутри описания - ЧЕРНЫЙ (перебиваем синий цвет) */
        .interp-body b, .interp-body strong {
            color: #000000;
            font-weight: 700;
        }

        #error-log { color: red; font-size: 12px; padding: 10px; background: #fff0f0; display: none; }
    </style>
</head>
<body>

<div class="container">
    <img src="background.png" class="bg-image">
    <div id="numbers-overlay"></div>
</div>

<div class="content">
    <div id="error-log"></div>
    <div id="text-content">Загрузка трактовок...</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('inner', this)">ВНУТРЕННИЙ</div>
    <div class="tab" onclick="switchTab('outer', this)">ВНЕШНИЙ</div>
    <div class="tab" onclick="switchTab('contact', this)">ОКРУЖЕНИЕ</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    if(tg) tg.expand();

    // ✅ ТВОИ КЛЮЧИ СОХРАНЕНЫ:
    const SUPABASE_URL = 'https://cfxywxzrihguvcokacgw.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_qWwvrriEOPMUdgfjdOnmOA__U2RrkRU';

    let myData = { values: {}, texts: { inner: "", outer: "", contact: "" } };

    // Показываем ошибки на экране, если что-то пойдет не так
    function showError(msg) {
        const el = document.getElementById('error-log');
        el.style.display = 'block';
        el.innerHTML = "⚠️ " + msg;
    }

    async function init() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. Расставляем цифры
        const positions = {
            15: {x: 53.6, y: 43.8}, 1: {x: 46.0, y: 52.5}, 2: {x: 53.5, y: 52.5},
            3: {x: 61.0, y: 52.5}, 4: {x: 50.0, y: 59.5}, 5: {x: 57.0, y: 59.5},
            6: {x: 53.5, y: 66.5}, 11: {x: 39.5, y: 56.5}, 13: {x: 42.0, y: 62.0},
            14: {x: 42.0, y: 66.8}, 12: {x: 47.0, y: 70.0}, 7: {x: 67.5, y: 56.5},
            9: {x: 64.5, y: 62.0}, 10: {x: 64.5, y: 66.8}, 8: {x: 60.0, y: 70.0}
        };

        const overlay = document.getElementById('numbers-overlay');
        for (let i = 1; i <= 15; i++) {
            const val = params.get(`p${i}`);
            if (val) {
                myData.values[i] = val;
                if (positions[i]) {
                    overlay.innerHTML += `<div class="number" style="left:${positions[i].x}%; top:${positions[i].y}%">${val}</div>`;
                }
            }
        }

        // 2. Скачиваем базу (с сортировкой, чтобы позиции шли по порядку)
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/portret_interpretations?select=*&order=position_number.asc`, {
                headers: { 
                    'apikey': SUPABASE_KEY, 
                    'Authorization': `Bearer ${SUPABASE_KEY}` 
                }
            });
            
            if (!response.ok) throw new Error(`Ошибка доступа к базе: ${response.status}`);
            
            const allTexts = await response.json();
            
            if (allTexts.length === 0) {
                document.getElementById('text-content').innerHTML = "База пуста.";
                return;
            }

            // 3. Сопоставляем цифры и раскладываем по папкам
            let foundCount = 0;
            allTexts.forEach(row => {
                const dbPos = Number(row.position_number);
                const dbArc = Number(row.arcana_number);
                const userArc = Number(myData.values[dbPos]);

                // Если аркан совпал
                if (userArc === dbArc) {
                    const desc = row.description ? row.description.replace(/\\n/g, '<br>').replace(/\n/g, '<br>') : "";
                    
                    // ФОРМИРУЕМ КРАСИВЫЙ БЛОК
                    // Заголовок: синий, без слова "Позиция", только цифра и название
                    const html = `
                        <div class="interp-block">
                            <div class="interp-header">${dbPos}. ${row.title}</div>
                            <div class="interp-body">${desc}</div>
                        </div>
                    `;
                    
                    if (dbPos <= 6) myData.texts.inner += html;
                    else if (dbPos <= 10) myData.texts.outer += html; // Включает 7, 8, 9, 10
                    else if (dbPos <= 15) myData.texts.contact += html; // Включает 11, 12, 13, 14, 15
                    foundCount++;
                }
            });

            if (foundCount > 0) switchTab('inner', document.querySelector('.tab.active'));
            else document.getElementById('text-content').innerHTML = "Трактовки не найдены для этих цифр.";

        } catch (err) {
            showError("Не удалось загрузить данные. " + err.message);
        }
    }

    function switchTab(type, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        const text = myData.texts[type];
        document.getElementById('text-content').innerHTML = text ? text : "Нет данных для этого раздела.";
        // Прокрутка вверх при переключении вкладки
        document.querySelector('.content').scrollTop = 0;
    }

    window.onload = init;
</script>
</body>
</html>
